# 精班棋

## 游戏介绍

精班棋是一款自由度很高的将棋

这款游戏的最大特点就是地图的可自定义性以及对于扩展插件的高度支持

运用这些，你可以在精班棋中完全还原出中国象棋等棋类游戏

你可以在一台设备上进行**单人游戏**，也可以建立服务器进行**多人联机**，与其他人分享你的自定义地图与扩展插件

## 游戏规则及过程

选择一个地图，并选择单人游戏或多人联机以开始游戏

在开始游戏后，红方为先手，一人一步进行游戏，以先吃掉对方的首领棋子（任意1个即可）为胜利条件

每个棋子上会有可移动方向标注，其中`·`为可在该方向上移动一格，`*`为可移动无限格（直到棋盘边缘）

一些棋子在不同的位置会有不同的可移动方向

右键棋子可以查看该棋子详细信息

## 自定义地图

### 简介

自定义地图是`.xlsx`文件，其中包含3个表，分别对应棋子、棋盘与特殊规则

[查看自定义地图示例](https://github.com/amf14151/s27a_jbq/blob/main/map/example(5x6).xlsx)

### 棋盘构造

行坐标轴（纵轴）为`x`，列坐标轴（横轴）为`y`

自左上至右下坐标轴编号**由1递增**，自右下至左上坐标轴编号**由-1递减**

在进行下表编写时均以**红方棋盘**为正向

### 棋子表

棋子表的名称为`chesses`

棋子表中会有一些通用的语法规则，规则如下：

1. 棋盘位置规则

   - 单个棋盘位置规则表示为`M[a|b|c]`的形式，其中`M`为规则名，为大写，`a`、`b`、`c`等为参数，为整数，用`|`隔开
   - 可使用的规则名：
     - `X[m|n|...]`，当棋子所在的行数等于任意一个参数（`m`、`n`等）时，该规则的值为`true`，否则为`false`
     - `Y[m|n|...]`，当棋子所在的列数等于任意一个参数（`m`、`n`等）时，该规则的值为`true`，否则为`false`
     - `P[x|y]`，当棋子所在的位置等于`(x,y)`时，该规则的值为`true`，否则为`false`
   - 其他规则名返回值为`false`
   - 多个棋盘位置规则间用`&`连接（`&`表示**或**，即棋子位置只要有一项满足该棋盘位置规则则返回值为`true`）
   - 示例：`X[1|-1]&Y[1|-1]`表示棋盘边缘区域

2. 可移动规则

   - 该语法规则分为两部分，第一部分为可以向某方向移动一格，第二部分为可以向某方向移动无限格。两部分语法相同，两部分间用`;`隔开
   - 在每一部分中，用`,`分隔开所有可移动方向，这些方向按**左上、上、右上、左、右、左下、下、右下**分别对应1-8
   - 如果这一方向上是否可以移动有位置限制，可以在方向编号后加上`()`，并在内部填入*棋盘位置规则*
   - 在第二部分中出现的可移动方向可以不出现在第一部分中
   - 如果没有第二部分（或第一部分）也需要在后面（或前面）加上`;`
   - 示例：`1(Y[4|5|6]),3(Y[2|3|4]),4(Y[7]),5(Y[1]);2`

棋子表的每一列内容依次是：

```
编号 名称 归属 首领 可移动 升变条件 升变后可移动
```

这些内容必须**按序**排列，具体填写规则如下：

1. 编号

   - 每个棋子独立的不同的编号
   - 按照顺序由1递增

2. 名称

   - 可以重复
   - 长度尽量**小于等于3**

3. 归属
   
   - 红方为1，蓝方为2，中立为3
   - 中立棋子双方都可以移动，但既不能吃子也不能被吃

4. 首领

   - 默认值为空，如果某棋子是首领则需要填入`c`
   - 首领数量不限，但每方至少需要1个（否则将无法结束游戏）

5. 可移动
   
   - 填入*可移动规则*

6. 升变条件

   - 填入*棋盘位置规则*，默认值为空，即不启用升变
   - 当棋子位置符合升变条件时，其可移动规则永久变为*升变后可移动*

7. 升变后可移动

   - 填入*可移动规则*
   - 该角色无法升变时仍需填写`;`


### 棋盘表

棋盘表的名称为`map`

棋盘表由两部分组成：棋盘行列数、棋盘布局

棋盘行列数在表的第一行，格式如下：

```
行  [填写总行数]  列  [填写总列数]
```

棋盘布局自第二行起，每格填写对应棋子编号，空位不填

### 特殊规则表

特殊规则表为提前预定格式，每项特殊规则默认不启用，如果启用则需要填入`c`

特殊规则介绍：

- 启用升变：一些棋子在达成某些条件后会升变，获得更强的移动方式
- 启用悔棋：在对方走出下一步前可以悔棋（仅限单人模式）
- 限制连续3步以上移动中立棋子：一方连续移动中立棋子的步数达到3次时本回合将不能继续移动中立棋子，该规则对于所有中立棋子通用

## 扩展

### 简介

扩展是`.py`文件，是用`Python`语言按照一定规则编写的一段代码块

扩展将会作为一段内置代码段进行执行，并在相应位置调用

在`设置`中可以导入扩展，也可以手动添加到运行文件下的`extensions`文件夹下。取消扩展可以删除文件，也可以将文件扩展名改为除`.py`的其他扩展名

### 数据类型

1. 棋子

   ``` python
   class Chess:
      self.id # 棋子编号
      self.name # 棋子名称
      self.belong # 棋子归属
      self.is_captain # 棋子是否为首领
      self.is_tran # 棋子是否已升变
   ```

### 接口

扩展接口如下：

- 对局信息

   ``` python
   JBQ.turn # 当前回合（1为红方，2为蓝方）
   ```

- 棋盘行列

   ``` python
   JBQ.rl # 棋盘行数
   JBQ.cl # 棋盘列数
   ```
   `int`值。为当前棋盘的行数和列数

- 方向距离计算

   ``` python
   JBQ.get_arr_by_rd(arr:tuple[int,int],r:int,d:int)
   ```
   函数。传入参数`arr`为二元组`(i,j)`，依次为棋盘的行数、列数（以`0`起始），`r`相对于`arr`的方向（1-8，参见上文），`d`为相对于`arr`的距离；返回值为二元组，若超出棋盘范围则返回`None`

- 占据情况

   ``` python
   JBQ.get_chess_by_arr(arr:tuple[int,int])
   ```
   函数。传入参数`arr`为二元组，依次为棋盘的行数、列数；返回值为`Chess`对象或`None`

- 棋子位置

   ``` python
   JBQ.get_chess_arr_by_id(id:int)
   ```
   函数。传入参数`id`为`int`值，是棋子的编号；返回值为二元组，依次为棋子所在的行数、列数。当场上有多个该编号的棋子或无该编号的棋子时返回值为`None`

### 具体函数

1. 棋盘位置规则函数

   ``` python
   def loc_func(args:tuple[int],arr:tuple[int,int]):
      ...
      return False
   ```

   - 在触发*棋盘位置规则*时触发相对应的函数
   - 传入参数有两个。`args`参数即对应*棋盘位置规则*中的参数；`arr`参数是触发该*棋盘位置规则*的棋子的位置（同上）
   - 返回值为`bool`值，代表该规则触发与否

2. `check_can_go`函数

   ``` python
   def check_can_go(can_go:list[tuple[int,int]],chess,arr:tuple[int,int]):
      ...
      return list[tuple[int,int]](...)
   ```

   - 在每颗棋子被选择时触发相对应的函数
   - 传入参数有三个。`can_go`参数为列表，列表每一项中的二元组表示原来能走的格子；`chess`参数是棋子本身，可以调用棋子相关的API
   - 返回值为`bool`值，代表该规则触发与否
   - 注意：此处修改`can_go`的扩展顺序以扩展导入顺序为准

### 构造

扩展文件由以下几部分组成：

``` python
EX_NAME = "[name]"
loc_rules = {
   "[i1]":func1,
   "[i2]":func2
}
```

其中`[name]`为该扩展名；`[i1]`等为棋盘位置规则名,`func1`等分别为该规则名对应的棋盘位置规则函数

## 多人联机（未开发完成）

### 服务端

服务端需自行下载并搭载，搭载后保持运行即可

### 客户端

选择地图后，可以创造一个新房间并等待加入，也可以通过输入房间名的方式加入一个未正在进行对局的房间。对局结束或任意一方退出时房间将会解散